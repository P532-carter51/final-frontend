<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlavorFind - Search Places</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .search-section {
            background-color: #f8f9fa;
            padding: 50px 0;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-img-top {
            max-height: 200px;
            object-fit: cover;
        }

        .category-header {
            background-color: #f1f1f1;
            padding: 15px;
            margin-top: 30px;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .filter-section {
            background-color: #f1f1f1;
            padding: 30px 0;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">FlavorFind</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="search.html">Search Places</a></li>
                    <li class="nav-item"><a class="nav-link" href="view-itineraries.html">View Itineraries</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Filter Section -->
    <section class="filter-section text-center">
        <div class="container">
            <h3>Filter Results</h3>
            <div class="row">
                <div class="col-md-4">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="ratingFilter">Rating</label>
                    <select id="ratingFilter" class="form-control">
                        <option value="">All Ratings</option>
                        <option value="4">4.0+</option>
                        <option value="4.5">4.5+</option>
                        <option value="5">5.0</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="priceFilter">Price Range</label>
                    <select id="priceFilter" class="form-control">
                        <option value="">All Prices</option>
                        <option value="1">$</option>
                        <option value="2">$$</option>
                        <option value="3">$$$</option>
                        <option value="4">$$$$</option>
                    </select>
                </div>
            </div>
            <button id="applyFilters" class="btn btn-primary mt-3">Apply Filters</button>
        </div>
    </section>

    <!-- Search Bar -->
    <section class="search-section text-center">
        <div class="container">
            <h2 class="mb-4">Search for Places</h2>
            <form id="searchForm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="location" placeholder="Enter city or location" />
                    <button class="btn btn-primary" type="submit">Search</button>
                </div>
            </form>
        </div>
    </section>

    <!-- Results -->
    <section id="results" class="py-5">
        <div class="container">
            <h3 class="mb-4">Search Results</h3>
            <div class="row" id="places"></div>
        </div>
    </section>

    <footer class="bg-dark text-white text-center py-3">
        <p>&copy; 2025 FlavorFind | All Rights Reserved</p>
    </footer>

    <script>
        const params = new URLSearchParams(window.location.search);
        const itineraryId = params.get("itineraryId");
        const defaultCity = params.get("city");

        const categoryFilter = document.getElementById("categoryFilter");

        fetch("https://flavorfind-backend.onrender.com/api/places/categories?location=Detroit")
            .then(resp => resp.json())
            .then(data => {
                data.categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });

                // ✅ Only auto-search AFTER categories are populated
                if (defaultCity) {
                    document.getElementById("location").value = defaultCity;
                    applySearch();
                }
            });

        document.getElementById('searchForm').addEventListener('submit', function (event) {
            event.preventDefault();
            applySearch();
        });

        document.getElementById('applyFilters').addEventListener('click', function () {
            applySearch();
        });

        function applySearch() {
            const location = document.getElementById("location").value;
            const category = categoryFilter.value;
            const ratingRaw = document.getElementById("ratingFilter").value;
            const rating = ratingRaw ? parseFloat(ratingRaw) : null;
            const price = document.getElementById("priceFilter").value;
            
            console.log("Location:", location);
            console.log("Category:", category);
            console.log("Rating (raw):", ratingRaw);
            console.log("Rating (parsed):", rating);
            console.log("Price:", price);

            let url = `https://flavorfind-backend.onrender.com/api/places/tree?location=${location}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            if (rating !== null) url += `&minRating=${rating}`;
            if (price) url += `&price=${price}`;
            
            console.log("Final search URL:", url);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("places");
                    container.innerHTML = "";
                    if (data && data.children) {
                        data.children.forEach(cat => {
                            container.innerHTML += `<div class="col-12 category-header"><h4>${cat.name}</h4></div>`;
                            cat.children.forEach(placeData => {
                                const p = placeData.place;
                                const imgUrl = p.imageUrl || 'https://via.placeholder.com/400x200';
                                const address = p.address || 'No address provided';

                                let card = `
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                    <img src="${imgUrl}" class="card-img-top" alt="${p.name}">
                                    <div class="card-body">
                                        <h5 class="card-title">${p.name}</h5>
                                        <p class="card-text">${p.description || 'No description provided.'}</p>
                                        <p><strong>Category:</strong> ${p.category} | <strong>Rating:</strong> ${p.rating}</p>`;


                                if (itineraryId) {
                                    card += `
                        <button class="btn btn-success btn-sm" onclick="addPlaceToItinerary('${p.name}', '${address.replace(/'/g, "\\'")}')">
                          ➕ Add to Itinerary
                        </button>`;
                                }

                                card += `
                      </div>
                    </div>
                  </div>`;
                                container.innerHTML += card;
                            });
                        });
                    }
                })
                .catch(error => console.error("Error fetching places:", error));
        }

        function addPlaceToItinerary(name, address) {
            fetch(`https://flavorfind-backend.onrender.com/api/itineraries/${itineraryId}/add-place`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, address: address })
            })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to add place");
                    return res.json();
                })
                .then(data => {
                    alert(`${name} added to itinerary!`);
                })
                .catch(err => {
                    console.error(err);
                    alert("Error adding place to itinerary.");
                });
        }
    </script>
</body>

</html>